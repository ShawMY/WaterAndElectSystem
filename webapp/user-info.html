<!--_meta 作为公共模版分离出去-->
<!DOCTYPE HTML>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="renderer" content="webkit|ie-comp|ie-stand">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
		<meta http-equiv="Cache-Control" content="no-siteapp" />
		<link rel="Bookmark" href="favicon1.ico">
		<link rel="Shortcut Icon" href="favicon1.ico" />
		<!--[if lt IE 9]>
<script type="text/javascript" src="lib/html5.js"></script>
<script type="text/javascript" src="lib/respond.min.js"></script>
<![endif]-->
		<link rel="stylesheet" type="text/css" href="static/h-ui/css/H-ui.min.css" />
		<link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/H-ui.admin.css" />
		<link rel="stylesheet" type="text/css" href="lib/Hui-iconfont/1.0.8/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="static/h-ui.admin/skin/default/skin.css" id="skin" />
		<link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/style.css" />
		<!--[if IE 6]>
<script type="text/javascript" src="http://lib.h-ui.net/DD_belatedPNG_0.0.8a-min.js" ></script>
<script>DD_belatedPNG.fix('*');</script><![endif]-->
		<!--/meta 作为公共模版分离出去-->

		<title>用户信息管理 - 用户管理 - 浙江工商大学水电管理系统</title>
	</head>

	<body>
		<!--_header 作为公共模版分离出去-->
		<div class="_header"></div>
		<!--/_header 作为公共模版分离出去-->

		<!--_menu 作为公共模版分离出去-->
		<div class="_menu"></div>
		<!--/_menu 作为公共模版分离出去-->

		<section class="Hui-article-box">
			<div class="Hui-article">
				<article class="cl pd-5">
					<div class="cl">
						<form class="form form-horizontal" id="form-member-add">
							<div class="col-sm-12">
								<div class="col-sm-3 pl-0 pr-0">
									<label class="form-label col-xs-4 col-sm-4 pr-0">用户编号：</label>
									<div class="formControls col-xs-8 col-sm-8 pl-0 pr-0">
										<input type="text" class="input-text" value="" placeholder="" id="search-code" name="code">
									</div>
								</div>
								<div class="col-sm-3 pl-0 pr-0">
									<label class="form-label col-xs-3 col-sm-3 pl-0 pr-0">用户名称：</label>
									<div class="formControls col-xs-8 col-sm-8 pl-0 pr-0">
										<input type="text" class="input-text" value="" placeholder="" id="name" name="name">
									</div>
								</div>
								<div class="col-sm-3 pl-0 pr-0">
									<label class="form-label col-xs-3 col-sm-3 pl-0 pr-0">用户类别：</label>
									<div class="formControls col-xs-8 col-sm-8 pl-0 pr-0">
										<span class="select-box">
											<select class="select" size="1" name="typeName" id="typeName">
												<!--<option value="1" selected>公共</option>-->
											</select>
										</span>
									</div>
								</div>
								<div class="col-sm-3 pl-0 pr-0">
									<label class="form-label col-xs-3 col-sm-3 pl-0 pr-0">表记编号：</label>
									<div class="formControls col-xs-8 col-sm-8 pl-0 pr-0">
										<input type="text" class="input-text" value="" placeholder="" id="meterCode" name="meterCode">
									</div>
								</div>
							</div>
							<div class="col-sm-12 mt-10">
								<div class="col-sm-3 pl-0 pr-0">
									<label class="form-label col-xs-4 col-sm-4 pr-0">联系人：</label>
									<div class="formControls col-xs-8 col-sm-8 pl-0 pr-0">
										<input type="text" class="input-text" value="" placeholder="" id="contactPeople" name="contactPeople">
									</div>
								</div>
								<div class="col-sm-3 pl-0 pr-0">
									<label class="form-label col-xs-3 col-sm-3 pl-0 pr-0">联系电话：</label>
									<div class="formControls col-xs-8 col-sm-8 pl-0 pr-0">
										<input type="text" class="input-text" value="" placeholder="" id="contactPhone" name="contactPhone">
									</div>
								</div>
								<div class="col-sm-3 pl-0 pr-0">
									<label class="form-label col-xs-3 col-sm-3 pl-0 pr-0">表记类别：</label>
									<div class="formControls col-xs-8 col-sm-8 pl-0 pr-0">
										<span class="select-box">
											<select class="select" size="1" name="meterType" id="meterType">
												<option value="" selected></option>
												<option value="水">水</option>
												<option value="电">电</option>
											</select>
										</span>
									</div>
								</div>
								<div class="col-sm-3 pl-0 pr-0 text-c">
									<button class="btn btn-success radius" type="button" id="btn-search" name=""><i class="Hui-iconfont">&#xe665;</i> 查询</button>
								</div>
							</div>
						</form>
					</div>
					<div class="cl pd-5 bg-1 bk-gray mt-20" id="btn-area"> <span class="l"><a href="javascript:;" onclick="member_add('新增用户','user-add.html','','550')" class="btn btn-primary radius"><i class="Hui-iconfont">&#xe600;</i> 新增用户</a> <a href="javascript:;" onclick="datadel()" class="btn btn-danger radius"><i class="Hui-iconfont">&#xe6e2;</i> 批量删除</a> </span></div>
					<div class="mt-20">
						<table id="example1" class="table table-border table-bordered table-hover table-bg table-sort" cellspacing="0" width="100%">
							<thead>
								<tr>
									<th><input type="checkbox" name="keeperUserGroup-checkable" value="" id="allChecked"></th>
									<th>序号</th>
									<th>用户编号</th>
									<th>用户名称</th>
									<th>用户类别代码</th>
									<th>用户类别名称</th>
									<th>表记编号</th>
									<th>表记类别</th>
									<th>付款方式</th>
									<th>开户时间</th>
									<th>销户时间</th>
									<th>联系人</th>
									<th>联系电话</th>
									<th width="150">操作</th>
								</tr>
							</thead>
						</table>
						<div id="paging" class="text-c mt-30"></div>
					</div>
				</article>
			</div>
		</section>

		<!--_footer 作为公共模版分离出去-->
		<script type="text/javascript" src="ip.js"></script>
		<script type="text/javascript" src="lib/jquery/1.9.1/jquery.min.js"></script>
		<script type="text/javascript" src="lib/layer/2.4/layer.js"></script>
		<script type="text/javascript" src="static/h-ui/js/H-ui.js"></script>
		<script type="text/javascript" src="static/h-ui.admin/js/H-ui.admin.page.js"></script>
		<!--/_footer /作为公共模版分离出去-->

		<!--请在下方写此页面业务相关的脚本-->
		<script type="text/javascript" src="lib/My97DatePicker/4.8/WdatePicker.js"></script>
		<script type="text/javascript" src="lib/datatables/1.10.0/jquery.dataTables.min.js"></script>
		<script type="text/javascript" src="lib/laypage/1.2/laypage.js"></script>
		<script type="text/javascript">
			/*公共数据*/
//			var ip = 'http://101.132.45.14:8080/shuidiansystem';
			var getUrl = '/api/user';
			var delUrl = '/api/user';
			//表格数据
			var dataSet = [];
			//所有用户类别
			var str = '<option value=""></option>',
				str2 = '<option value=""></option>';

			$(function() {
				/*导入公共组件*/
				$("._header").load("_header.html");
				$("._menu").load("_menu.html");
				isLogin();
				setRole();
				getList(1);
			});

			function isLogin() {
				if($.cookie("isLogin") == 'null') {
					window.location.href = "loginTip.html";
				}
			}

			function setRole() {
				role = $.cookie('role');
				role = parseInt(role);
				switch(role) {
					case 1:
						break;
					case 2:
						break;
					case 3:
						break;
					case 4:
						break;
					case 5:
						$("#btn-area").addClass("hidden");
						break;
					case 6:
						break;
					case 7:
						break;
					default:
						location.href("loginTip.html");
						break;
				}
			}

			/*填充表格*/
			function setTable() {
				//checked
				checkedSet = [];

				/*表格数据动态渲染*/
				var resultTable = $('#example1').DataTable({
					data: dataSet,
					columns: [{
							className: "td-checkbox",
							data: null,
							width: '30px',
							render: function(data, type, row, meta) {
								var content = '<label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">';
								var obj = {
									userId: data.code,
									meterId: data.meterCode
								};
								if(isOwn(obj) > -1) {
									content = content + '<input type="checkbox" class="group-checkable" value="' + data.code + '" name="' + data.meterCode + '" checked/>';
								} else {
									content = content + '<input type="checkbox" class="group-checkable" value="' + data.code + '" name="' + data.meterCode + '"/>';
								}
								content = content + '<span></span>';
								content = content + '</label>';
								return content;
							}
						}, {
							title: "序号",
							width: '30px',
							data: null
						},
						{
							title: "用户编号",
							data: "code"
						},
						{
							title: "用户名称",
							data: "name"
						},
						{
							title: "用户类别代码",
							data: "typeCode"
						},
						{
							title: "用户类别名称",
							data: "typeName"
						},
						{
							title: "表记编号",
							data: "meterCode"
						},
						{
							title: "表记类别",
							data: "meterType"
						},
						{
							title: "付款方式",
							data: "payment"
						},
						{
							title: "开户时间",
							data: "openTime"
						},
						{
							title: "销户时间",
							data: "closeTime"
						},
						{
							title: "联系人",
							data: "contactPeople"
						},
						{
							title: "联系电话",
							data: "contactPhone"
						},
						{
							title: "操作",
							data: null,
							width: '80px',
							render: function(data, type, row) {
								//data为当前列的数据
								//type为当前列数据类型
								//row为当前行数据
								var rowData = JSON.stringify(row);
								if(role == 5) {
									var str = "<span class=''><a class='btn btn-primary radius inline disabled' disabled>编辑</a>";
								} else {
									var str = "<span class=''><a class='btn btn-primary radius inline' onclick='member_edit(" + rowData + ")'>编辑</a>";
								}
								return str;
								//此处return可自己定义，传参须注意，若传字符串需加上转义字符，否则会报错ReferenceError: XXX is not defined at HTMLAnchorElement.onclick
							}
						}
					],
					aoColumnDefs: [{
						orderable: false,
						aTargets: [0, 1, 13]
					}],
					paging: false,
					searching: false,
					bFilter: false,
					info: false,
				});

				/* 设置第一列 - 序列化 */
				resultTable.on('order.dt search.dt', function() {
					resultTable.column(1, {
						search: 'applied',
						order: 'applied'
					}).nodes().each(function(cell, i) {
						cell.innerHTML = i + 1;
					});
				}).draw();

				/*复选框*/
				$('#example1').on("change", ":checkbox", function() {
					if($(this).is("[name='keeperUserGroup-checkable']")) {
						// 全选
						if($(this).is(':checked')) {
							getAllCode();
						} else {
							cancelAllChecked();
						}
					} else {
						var obj = {
							userId: $(this).val(),
							meterId: $(this).attr("name")
						};
						var hasIt = -1;
						$.each(checkedSet, function(index, value) {
							console.log("========");
							console.log(value.userId == obj.userId);
							console.log(value.meterId == obj.meterId);
							if((value.userId == obj.userId) && (value.meterId == obj.meterId)) {
								hasIt = index;
							}
						});
						// 一般复选
						if($(this).is(':checked')) {

							console.log(hasIt)
							if(hasIt == -1) {
								checkedSet.push(obj);
							}
						} else {
							if(hasIt > -1) {
								checkedSet.splice(hasIt, 1);
							}
						}
					}
					console.log(checkedSet);
				});

				/*遍历-获取所有typeCode*/
				function getAllCode() {
					checkedSet = [];
					$.each(dataSet, function(index, value) {
						var obj = {
							userId: value.code,
							meterId: value.meterCode
						};
						checkedSet.push(obj);
					});
				}

				/*取消全选*/
				function cancelAllChecked() {
					checkedSet = [];
				}
			}

			function isOwn(obj) {
				var hasIt = -1;
				$.each(checkedSet, function(index, value) {
					console.log("========");
					console.log(value.userId == obj.userId);
					console.log(value.meterId == obj.meterId);
					if((value.userId == obj.userId) && (value.meterId == obj.meterId)) {
						hasIt = index;
					}
				});
				return hasIt;
			}

			/*用户类别-获取*/
			$(document).ready(function() {
				/*公共数据*/
//				var ip = 'http://101.132.45.14:8080/shuidiansystem';
				var getItemUrl = '/api/user/cat/item';

				$.ajax({
					type: "get",
					url: ip + getItemUrl,
					async: true,
					success: function(res) {
						if(res.code == 200) {
							var data = res.content;
							$.each(data, function(index, value) {
								str += "<option value='" + value.typeName + "'>" + value.typeName + "</option>";
								str2 += "<option value='" + value.typeCode + "'>" + value.typeName + "</option>";
							});
							//将用户类别填充到搜索部分
							$("#typeName").html(str);
						} else {
							layer.msg(res.msg, {
								icon: 2,
								time: 3000
							});
						}
					}
				});
			});

			/* 根据分页获取列表信息 */
			function getList(curr) {
				$.ajax({
					type: "get",
					url: ip + getUrl,
					data: {
						page: curr
					},
					dataType: 'json',
					contentType: 'application/json',
					success: function(res) {
						if(res.code == 200) {
							dataSet = res.content.info;
							if($('#example1').hasClass('dataTable')) {
								var oldTable = $('#example1').dataTable();
								oldTable.fnClearTable(); //清空一下table
								oldTable.fnDestroy(); //还原初始化了的dataTable
								$('#example1').empty();
							}
							setTable();
							pagination(res.content.page, res.content.pageNum, 0);
						} else {
							layer.msg(res.msg, {
								icon: 2,
								time: 3000
							});
						}

					},
					async: true
				});
			}

			/*用户-添加*/
			function member_add(title, url, w, h) {
				layer_show(title, url, w, h);
			}

			/*用户-编辑*/
			function member_edit(data) {
				layer.open({
					type: 2,
					area: ['800px', '590px'],
					fix: false, //不固定
					maxmin: true,
					shade: 0.4,
					title: '编辑',
					content: 'user-edit.html',
					success: function(layero, index) {
						var body = layer.getChildFrame('body', index);
						var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();

						body.find("#typeName").html(str2);

						getCode(data.meterType);
						//将用户类别填充到搜索部分
						body.find("#meterCode").html(str3);

						$.each(data, function(key, value) {
							var obj = '#' + key;
							body.find(obj).val(value);
						});
					},
					end: function() {
						location.reload();
					}
				});
			}

			var str3 = "<option value=''></option>";

			function getCode(type) {
				//根据表记类型获取所有表记编号
				var getCodeUrl = '/api/code/meter';
				$.ajax({
					type: "get",
					url: ip + getCodeUrl,
					async: false,
					data: {
						type: type
					},
					success: function(res) {
						if(res.code == 200) {
							var data = res.content;
							$.each(data, function(index, value) {
								str3 = str3 + "<option value='" + value + "'>" + value + "</option>";
								$("#meterCode").html(str3);
							});
						} else {
							layer.msg(res.msg, {
								icon: 2,
								time: 3000
							});
						}

					}
				});
			}

			/*用户-查询*/
			$("#btn-search").click(function() {
				searchObj = {
					code: $('#code').val(),
					name: $('#name').val(),
					typeName: $('#typeName').val(),
					meterType: $('#meterType').val(),
					meterCode: $('#meterCode').val(),
					contactPeople: $('#contactPeople').val(),
					contactPhone: $('#contactPhone').val(),
					page: 1
				}
				search(1, searchObj);
			});

			var searchObj = {};

			function search(curr, obj) {
				var searchUrl = '/api/user/some';
				obj.page = curr;
				$.ajax({
					type: "get",
					url: ip + searchUrl,
					data: obj,
					dataType: 'json',
					success: function(res) {
						if(res.code == 200) {
							dataSet = res.content.info;
							if($('#example1').hasClass('dataTable')) {
								var oldTable = $('#example1').dataTable();
								oldTable.fnClearTable(); //清空一下table
								oldTable.fnDestroy(); //还原初始化了的dataTable
								$('#example1').empty();
							}
							setTable();
							pagination(res.content.page, res.content.pageNum, 1);
						} else {
							layer.msg(res.msg, {
								icon: 2,
								time: 3000
							});
						}

					},
					async: true
				});
			}

			/*用户-删除*/
			function member_del(data) {
				layer.confirm('确认要删除吗？', function(index) {
					del(data.code, data.meterCode, 0);
				});
			}

			function del(userId, meterId, type) {
				if(type == 0) { //单个删除
					var ids = [];
					var obj = {
						userId: userId,
						meterId: meterId
					}
					ids.push(obj);
				} else {
					var ids = checkedSet;
				}

				if(ids.length < 1) {
					layer.msg('请选择删除选项!', {
						icon: 2,
						time: 2000
					});
					return false;
				}

				$.ajax({
					type: "delete",
					url: ip + delUrl,
					data: JSON.stringify(ids),
					contentType: 'application/json',
					dataType: 'json',
					async: true,
					success: function(res) {
						if(res.code == 200) {
							layer.msg(res.msg, {
								icon: 1,
								time: 2000
							});
						} else {
							layer.msg(res.msg, {
								icon: 2,
								time: 2000
							});
						}
						checkedSet = [];
						location.reload();

					}
				});
			}

			//批量删除
			function datadel() {
				layer.confirm('确认要删除吗？', function(index) {
					del(null, 1);
				});
				
			}

			//分页
			function pagination(curr, sum, type) { //type表示当前的分页方式
				laypage({
					cont: 'paging', //容器。值支持id名、原生dom对象，jquery对象。【如该容器为】：&lt;div id="page1">&lt;/div>
					pages: sum, //通过后台拿到的总页数
					curr: curr, //初始化当前页
					jump: function(e, first) { //触发分页后的回调
						if(!first) {
							if(type == 0) { //如果本次触发与查询无关
								getList(e.curr);
							} else {
								search(e.curr, searchObj);
							}
						}

					}
				});
			}
		</script>
		<!--/请在上方写此页面业务相关的脚本-->
	</body>

</html>